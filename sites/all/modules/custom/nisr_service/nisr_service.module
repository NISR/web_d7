<?php

/**
 * @file
 * Service module suite
 */

/*
 *	Implements hook_menu()
 */
function nisr_service_menu(){
	$items = array();
	
	$items['service--login']	= array(
		'title' => 'Login',
		'page callback' => 'nisr_service_login',
		'page arguments' => array(2),
		'access callback' => TRUE,
		'type' => MENU_CALLBACK,	
    	'theme callback' => 'variable_get',
    	'theme arguments' => array('admin_theme'),
	);
	$items['service--register']	= array(
	   'title' => 'Register',
		'page callback' => 'nisr_service_register',
		'page arguments' => array(2),
		'access callback' => TRUE,
		'type' => MENU_CALLBACK,	
	   'theme callback' => 'variable_get',
    	'theme arguments' => array('admin_theme'),
	);		
	$items['service/%']	= array(
		'page callback' => 'nisr_service_gateway',
		'page arguments' => array(1),
		'access callback' => TRUE,
		'type' => MENU_CALLBACK,	
		'theme callback' => 'variable_get',
    	'theme arguments' => array('admin_theme'),
	);		
	
			
	return $items;	
}

/* 
 * Service login menu callback
 */
function nisr_service_login($service){

	if(user_is_logged_in()) drupal_goto('service/' . $service);	
	
	return drupal_get_form('nisr_service_login_form',$service);
}

/*
 * Login form
 */
function nisr_service_login_form($form,&$form_state,$service){
	
	$form['username'] = array(
		'#type' => 'textfield',
		'#required' => TRUE,
		'#title' => t('Username'),
	);	
	
	$form['password'] = array(
		'#type' => 'password',
		'#required' => TRUE,
		'#title' => t('Password'),
	);	
	
	$form['service'] = array(
		'#type' => 'hidden',
		'#value' => $service,
	);	
	
	$form['actions']['submit'] = array(
		'#type' => 'submit',
		'#value' => t('Connect'),	
	);
	
	$form['new_user_register'] = array(
		'#markup'=> "<br/>New user,register <a href='/service--register/" . $service . "'>here</a>",
	);	
	
	drupal_set_title(t('Login'));
	
	return $form;
}

/* 
 * Service login menu callback
 */
function nisr_service_register($service){

	if(user_is_logged_in()) drupal_goto('service/' . $service);	
	
	return drupal_get_form('nisr_service_register_form',$service);
}

/*
 * Register form 
 */
function nisr_service_register_form($form,&$form_state,$service){
	// Personal info
	$form['pi'] = array(
		'#type' => 'fieldset',
		'#collapsible' => TRUE,
		'#title' => t('Personal information'),
	);
	
	$form['pi']['salutation'] = array(
		'#type' => 'select',
		'#required' => TRUE,
		'#options' => array(0 => t('Mr.'), 1 => t('Ms.'), 2 => t('Mrs.')),
		'#title' => t('Salutation'),
	);	
	
	$form['pi']['firstname'] = array(
		'#type' => 'textfield',
		'#required' => TRUE,
		'#title' => t('Firsttname'),
	);	
	
	$form['pi']['lastname'] = array(
		'#type' => 'textfield',
		'#required' => TRUE,
		'#title' => t('Lastname'),
	);	
		
	// Account info
	$form['account'] = array(
		'#type' => 'fieldset',
		'#collapsible' => TRUE,
		'#title' => t('Account information'),
	);
	
	$form['account']['username'] = array(
		'#type' => 'textfield',
		'#required' => TRUE,
		'#title' => t('Username'),
	);	
	
	$form['account']['password'] = array(
		'#type' => 'password_confirm',
		'#required' => TRUE,
	);	
	
	$form['actions']['submit'] = array(
		'#type' => 'submit',
		'#value' => t('Register'),	
	);
	
	drupal_set_title(t('Register'));
	
	return $form;	
}

/*
 * Login form submit handler
 */
function nisr_service_login_form_submit($form,&$form_state){
	
	if(!user_login_credentials($form_state['values']['username'],$form_state['values']['password'])){
		drupal_set_message(t('Wrong username or password'),'error');
	}
	
}

/*
 * Register form submit handler
 */
function nisr_service_register_form_submit($form,&$form_state){
	
}

/*
 * Service gateway
 */
function nisr_service_gateway($service){
	// Authenticate
	if(!user_is_logged_in()){
		drupal_goto('service--login',array('query'=>array('destination' => 'service/' . $service)));
	}else{
	// Render console
		return views_embed_view('service_' . $service);
	}
}

/**
 * Helper function to login a user. 
 * @param
 * 	string username
 *		string password
 * @return 
 *		boolean
 */
function user_login_credentials($username, $password) {
  if ($uid = user_authenticate($username, $password)) {
    $user_obj = user_load_by_name($username);
    $form_state = array();
    $form_state['uid'] = $uid;
    user_login_submit(array(),$form_state);
    return true;
  }
  else {
    return false;
  }
}